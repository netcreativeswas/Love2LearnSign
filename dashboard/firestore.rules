rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user has 'admin' role in custom claims
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.roles is list && 
             'admin' in request.auth.token.roles;
    }
    
    function isPlatformAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/platform/platform/members/$(request.auth.uid));
    }

    function signInProvider() {
      return request.auth != null ? request.auth.token.firebase.sign_in_provider : null;
    }

    function isGoogleSignIn() {
      return signInProvider() == 'google.com';
    }

    function tenantMemberExists(tenantId, uid) {
      return exists(/databases/$(database)/documents/tenants/$(tenantId)/members/$(uid));
    }

    function tenantRole(tenantId, uid) {
      return get(/databases/$(database)/documents/tenants/$(tenantId)/members/$(uid)).data.role;
    }

    function isTenantMember(tenantId) {
      return request.auth != null && tenantMemberExists(tenantId, request.auth.uid);
    }

    function isTenantAdminOrAbove(tenantId) {
      return isPlatformAdmin() || isAdmin() ||
             (isTenantMember(tenantId) && (tenantRole(tenantId, request.auth.uid) in ['owner', 'admin']));
    }

    function isTenantEditorOrAbove(tenantId) {
      return isPlatformAdmin() || isAdmin() ||
             (isTenantMember(tenantId) && (tenantRole(tenantId, request.auth.uid) in ['owner', 'admin', 'editor']));
    }
    
    // Helper function to check ownership
    function isOwnDocument() {
      return request.auth != null && 
             resource != null &&
             (resource.data.uid == request.auth.uid || resource.id == request.auth.uid);
    }
    
    match /users/{userId} {
      // ðŸš¨ Avoid broad `allow write` because it implicitly allows deletes.
      allow get, list, create, update: if isAdmin() || isPlatformAdmin();
      allow delete: if false;

      // FIX FOR DASHBOARD: 
      // Allow users to READ (get + list/listen) their own document based on ID or UID field.
      // This allows real-time snapshots needed by the dashboard.
      allow get: if request.auth != null &&
                 (userId == request.auth.uid || userId.matches('.*__' + request.auth.uid + '$'));

      // Users can create their own document
      allow create: if request.auth != null && 
                    userId == request.auth.uid &&
                    request.resource.data.uid == request.auth.uid &&
                    request.resource.data.roles is list &&
                    request.resource.data.approved is bool &&
                    request.resource.data.status is string &&
                    (
                      (isGoogleSignIn() &&
                       request.resource.data.approved == true &&
                       request.resource.data.status == 'approved' &&
                       request.resource.data.roles.size() == 1 &&
                       request.resource.data.roles[0] == 'freeUser')
                      ||
                      (!isGoogleSignIn() &&
                       request.resource.data.approved == false &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.roles.size() == 0)
                    );

      // Users can update their own document (but not roles, approved, status)
      allow update: if request.auth != null && 
                     userId == request.auth.uid &&
                     resource != null &&
                     isOwnDocument() &&
                     !('roles' in request.resource.data.diff(resource.data).affectedKeys()) &&
                     !('approved' in request.resource.data.diff(resource.data).affectedKeys()) &&
                     !('status' in request.resource.data.diff(resource.data).affectedKeys());

      allow delete: if false;
    }

    // Per-tenant premium entitlements (Option A co-brand SaaS).
    match /users/{userId}/entitlements/{tenantId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin() || isPlatformAdmin());
      allow create, update, delete: if isPlatformAdmin();
    }

    // IMPORTANT for collectionGroup('entitlements') queries:
    // Firestore evaluates collection group queries across ANY parent path that contains a subcollection named "entitlements".
    // So we must also provide a rule that matches entitlements docs under any parent path (not only /users/{uid}/...).
    // We keep this READ-ONLY and only for admins/platform admins.
    match /{parentPath=**}/entitlements/{entitlementId} {
      allow read: if request.auth != null && (isAdmin() || isPlatformAdmin());
      allow write: if false;
    }
    
    // Role change logs - admins only (for security audit trail)
    match /roleLogs/{logId} {
      allow get, list, create, update: if isAdmin() || isPlatformAdmin();
      allow delete: if false;
    }

    // Public categories
    match /categories/{categoryId} {
      allow read: if true;     // anyone can list/get categories
      allow write: if false;   // nobody can write
    }

    // Public words (if you have a top-level `words` collection)
    match /words/{wordId} {
      allow read: if true;
      allow write: if false;
    }

    // Per-user index of tenant access (for dashboard tenant discovery).
    // NOTE: This rules file is dashboard-scoped; keep consistent with app/firestore.rules.
    match /userTenants/{uid} {
      allow get: if request.auth != null && (request.auth.uid == uid || isAdmin() || isPlatformAdmin());
      allow list: if false;
      // Writes should only happen via platform admin tooling; dashboard uses isAdmin here.
      allow create, update, delete: if isPlatformAdmin();
    }

    // --- Multi-tenant schema needed by the dashboard ---
    match /apps/{appId} {
      allow read: if true; // branding discovery
      allow write: if isPlatformAdmin();
    }

    // Platform admin membership:
    // IMPORTANT: avoid recursion with isPlatformAdmin() by NOT referencing isPlatformAdmin() here.
    match /platform/platform/members/{uid} {
      allow get: if request.auth != null && request.auth.uid == uid;
      allow list, create, update, delete: if false;
    }

    match /platform/{doc=**} {
      allow read, write: if isPlatformAdmin();
    }

    match /tenants/{tenantId} {
      // Dashboard commonly lists tenants; restrict list to platform admins.
      allow get: if isPlatformAdmin() || isTenantMember(tenantId);
      allow list: if isPlatformAdmin();
      allow create, update: if isPlatformAdmin();
      allow delete: if false;

      match /members/{uid} {
        allow read: if isPlatformAdmin() || (request.auth != null && request.auth.uid == uid) || isTenantAdminOrAbove(tenantId);
        allow write: if isTenantAdminOrAbove(tenantId);
      }

      // Tenant monetization config (Option A). Readable by clients, writable by platform admin.
      match /monetization/{docId} {
        allow read: if true;
        allow write: if isPlatformAdmin();
      }

      // Dictionary / concepts (shared with app): the dashboard needs read/write here for the Word List + editor.
      match /concepts/{conceptId} {
        allow read: if isTenantMember(tenantId) || isPlatformAdmin() || isAdmin();
        allow create, update: if isTenantEditorOrAbove(tenantId);
        allow delete: if false;

        match /signs/{signLangId} {
          allow read: if isTenantMember(tenantId) || isPlatformAdmin() || isAdmin();
          allow create, update: if isTenantEditorOrAbove(tenantId);
          allow delete: if false;
        }
      }

      // Tenant-scoped search analytics (admins only).
      match /searchAnalytics/{entryId} {
        allow create: if false;
        allow get, list: if isTenantAdminOrAbove(tenantId) || isPlatformAdmin();
        allow update, delete: if false;
      }
    }
    
    // Dictionary collection: public read, editor/admin write only
    match /bangla_dictionary_eng_bnsl/{docEngBnslId} {
      allow read: if true;

      // Only users with editor or admin role can create/update
      allow create, update: if request.auth != null &&
                      (request.auth.token.roles is list && 
                       ('editor' in request.auth.token.roles || 'admin' in request.auth.token.roles));
      // Force destructive deletes through Cloud Functions (admin-only) to ensure Storage cleanup.
      allow delete: if false;
    }
    
    // This block to fix the splash intro fetch
    match /meta/intro {
      allow read: if true;    // public read for this single doc
      allow write: if false;  // no client writes
    }

    // Search analytics: allow authenticated clients to create entries, admins to read.
    match /searchAnalytics/{entryId} {
      function isReasonableTimestamp(ts) {
        // Accept serverTimestamp() (evaluates as request.time) AND client timestamps close to now.
        // This avoids accidental "no data" when writes use a slightly different timestamp representation.
        return ts is timestamp &&
               ts <= request.time &&
               ts >= request.time - duration.value(10, 'm');
      }
      function isValidSearchEntry() {
        return request.resource.data.keys().hasOnly([
          'query',
          'query_lower',
          'timestamp',
          'found',
          'resultCount',
          'sessionId',
          'category'
        ]) &&
        request.resource.data.query is string &&
        request.resource.data.query_lower is string &&
        request.resource.data.found is bool &&
        request.resource.data.resultCount is int &&
        request.resource.data.sessionId is string &&
        request.resource.data.category is string &&
        request.resource.data.query.size() >= 2 &&
        request.resource.data.query.size() <= 80 &&
        request.resource.data.query_lower.size() >= 2 &&
        request.resource.data.query_lower.size() <= 80 &&
        request.resource.data.sessionId.size() >= 8 &&
        request.resource.data.sessionId.size() <= 80 &&
        request.resource.data.category.size() >= 1 &&
        request.resource.data.category.size() <= 80 &&
        request.resource.data.resultCount >= 0 &&
        request.resource.data.resultCount <= 5000 &&
        (
          request.resource.data.timestamp == request.time ||
          isReasonableTimestamp(request.resource.data.timestamp)
        );
      }

      // Legacy path (kept for safety): disable client writes to prevent abuse.
      // Canonical analytics writes are tenant-scoped at /tenants/{tenantId}/searchAnalytics/{entryId}.
      allow create, update, delete: if false;
      allow get, list: if isAdmin() || isPlatformAdmin();
    }

    // Tenant-scoped search analytics (v2): allow logging for PUBLIC tenants and tenant admins to read.
    // (Kept here for parity; canonical rules live in app/firestore.rules.)
    match /tenants/{tenantId}/searchAnalytics/{entryId} {
      function isReasonableTimestamp(ts) {
        return ts is timestamp &&
               ts <= request.time &&
               ts >= request.time - duration.value(10, 'm');
      }
      function isValidSearchEntry() {
        return request.resource.data.keys().hasOnly([
          'query',
          'query_lower',
          'timestamp',
          'found',
          'resultCount',
          'sessionId',
          'category'
        ]) &&
        request.resource.data.query is string &&
        request.resource.data.query_lower is string &&
        request.resource.data.found is bool &&
        request.resource.data.resultCount is int &&
        request.resource.data.sessionId is string &&
        request.resource.data.category is string &&
        request.resource.data.query.size() >= 2 &&
        request.resource.data.query.size() <= 80 &&
        request.resource.data.query_lower.size() >= 2 &&
        request.resource.data.query_lower.size() <= 80 &&
        request.resource.data.sessionId.size() >= 8 &&
        request.resource.data.sessionId.size() <= 80 &&
        request.resource.data.category.size() >= 1 &&
        request.resource.data.category.size() <= 80 &&
        request.resource.data.resultCount >= 0 &&
        request.resource.data.resultCount <= 5000 &&
        (
          request.resource.data.timestamp == request.time ||
          isReasonableTimestamp(request.resource.data.timestamp)
        );
      }

      allow create: if isValidSearchEntry();
      allow get, list: if isAdmin();
      allow update, delete: if false;
    }

    // Tenant monetization config (Option A). Readable by clients (for ads + IAP), writable by admin.
    match /tenants/{tenantId}/monetization/{docId} {
      allow read: if true;
      allow write: if isPlatformAdmin();
    }
    
    // Catch-all: lock down everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
